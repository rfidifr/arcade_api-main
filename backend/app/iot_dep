import hmac
import hashlib
import time
from fastapi import Request, HTTPException, status, Depends
from bson import ObjectId
from app.database import get_db

ALLOWED_TIME_DRIFT = 3000  # seconds

async def verify_machine(
    request: Request,
    db = Depends(get_db),
):
    # 1Ô∏è‚É£ Extract headers
    machine_id = request.headers.get("X-Machine-Id")
    timestamp = request.headers.get("X-Timestamp")
    signature = request.headers.get("X-Signature")

    if not machine_id or not timestamp or not signature:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Missing authentication headers"
        )

    # 2Ô∏è‚É£ Validate timestamp format
    try:
        timestamp_int = int(timestamp)
    except ValueError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid timestamp"
        )

    # 3Ô∏è‚É£ Prevent replay attacks
    current_time = int(time.time())
    if abs(current_time - timestamp_int) > ALLOWED_TIME_DRIFT:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Request expired"
        )

    # 4Ô∏è‚É£ Fetch machine from MongoDB
    # CRITICAL: Use machine_id field, not _id
    machine = db.machines.find_one({"machine_id": machine_id})

    if not machine:
        print(f"‚ùå Machine not found: {machine_id}")
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid machine" 
        )

    # 5Ô∏è‚É£ Get card_id from body
    try:
        data = await request.json()
        card_id = data.get("card_id")
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            detail=f"Invalid JSON body: {str(e)}"
        )

    if not card_id:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Missing card_id"
        )

    # 6Ô∏è‚É£ Recreate message - IMPORTANT: Use timestamp as string!
    message = f"{machine_id}{card_id}{timestamp}"

    # 7Ô∏è‚É£ Recalculate HMAC
    expected_signature = hmac.new(
        machine["secret_key"].encode(),  # MongoDB returns dict, use bracket notation
        message.encode(),
        hashlib.sha256
    ).hexdigest()

    # üêõ DEBUG LOGGING
    print("=" * 50)
    print("DEBUG SIGNATURE VERIFICATION")
    print("=" * 50)
    print(f"Machine ID (header): {machine_id}")
    print(f"Card ID (body): {card_id}")
    print(f"Timestamp (header): {timestamp}")
    print(f"Timestamp type: {type(timestamp)}")
    print(f"Secret Key (DB): {machine['secret_key']}")
    print(f"Message: {message}")
    print(f"Message bytes: {message.encode()}")
    print(f"Received signature: {signature}")
    print(f"Expected signature: {expected_signature}")
    print(f"Signatures match: {hmac.compare_digest(expected_signature, signature)}")
    print("=" * 50)

    # 8Ô∏è‚É£ Constant-time comparison
    if not hmac.compare_digest(expected_signature, signature):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid signature"
        )

    # 9Ô∏è‚É£ Machine verified successfully
    return machine
